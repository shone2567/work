+ mysql -u root -pSuper123
+ . admin-openrc
++ export OS_PROJECT_DOMAIN_NAME=default
++ OS_PROJECT_DOMAIN_NAME=default
++ export OS_USER_DOMAIN_NAME=default
++ OS_USER_DOMAIN_NAME=default
++ export OS_PROJECT_NAME=admin
++ OS_PROJECT_NAME=admin
++ export OS_USERNAME=admin
++ OS_USERNAME=admin
++ export OS_PASSWORD=Super123
++ OS_PASSWORD=Super123
++ export OS_AUTH_URL=http://controller:35357/v3
++ OS_AUTH_URL=http://controller:35357/v3
++ export OS_IDENTITY_API_VERSION=3
++ OS_IDENTITY_API_VERSION=3
++ export OS_IMAGE_API_VERSION=2
++ OS_IMAGE_API_VERSION=2
+ openstack user create --domain default --password Super123 neutron
+-----------+----------------------------------+
| Field     | Value                            |
+-----------+----------------------------------+
| domain_id | 05fedb7006534e68b1f4de0c66110989 |
| enabled   | True                             |
| id        | 81039bf8f28345b7b20b08359255e233 |
| name      | neutron                          |
+-----------+----------------------------------+
+ openstack role add --project service --user neutron admin
+ openstack service create --name neutron --description 'OpenStack Networking' network
+-------------+----------------------------------+
| Field       | Value                            |
+-------------+----------------------------------+
| description | OpenStack Networking             |
| enabled     | True                             |
| id          | 57e3d9a3154a4fb4804fcfbd09c7bd32 |
| name        | neutron                          |
| type        | network                          |
+-------------+----------------------------------+
+ openstack endpoint create --region RegionOne network public http://controller:9696
+--------------+----------------------------------+
| Field        | Value                            |
+--------------+----------------------------------+
| enabled      | True                             |
| id           | c194db4ac39742b18b61fb77607795a6 |
| interface    | public                           |
| region       | RegionOne                        |
| region_id    | RegionOne                        |
| service_id   | 57e3d9a3154a4fb4804fcfbd09c7bd32 |
| service_name | neutron                          |
| service_type | network                          |
| url          | http://controller:9696           |
+--------------+----------------------------------+
+ openstack endpoint create --region RegionOne network internal http://controller:9696
+--------------+----------------------------------+
| Field        | Value                            |
+--------------+----------------------------------+
| enabled      | True                             |
| id           | 926d946f451a40c2a96bbf4ad4d2f5f0 |
| interface    | internal                         |
| region       | RegionOne                        |
| region_id    | RegionOne                        |
| service_id   | 57e3d9a3154a4fb4804fcfbd09c7bd32 |
| service_name | neutron                          |
| service_type | network                          |
| url          | http://controller:9696           |
+--------------+----------------------------------+
+ openstack endpoint create --region RegionOne network admin http://controller:9696
+--------------+----------------------------------+
| Field        | Value                            |
+--------------+----------------------------------+
| enabled      | True                             |
| id           | c7265b10249447be941eb7aa889ecd21 |
| interface    | admin                            |
| region       | RegionOne                        |
| region_id    | RegionOne                        |
| service_id   | 57e3d9a3154a4fb4804fcfbd09c7bd32 |
| service_name | neutron                          |
| service_type | network                          |
| url          | http://controller:9696           |
+--------------+----------------------------------+
+ echo 'installing neutron package on controller'
installing neutron package on controller
+ yum install -y openstack-neutron openstack-neutron-ml2 openstack-neutron-linuxbridge ebtables ipset
+ openstack-config --set /etc/neutron/neutron.conf DEFAULT core_plugin ml2
+ openstack-config --set /etc/neutron/neutron.conf DEFAULT service_plugins
+ openstack-config --set /etc/neutron/neutron.conf DEFAULT rpc_backend rabbit
+ openstack-config --set /etc/neutron/neutron.conf DEFAULT auth_strategy keystone
+ openstack-config --set /etc/neutron/neutron.conf DEFAULT notify_nova_on_port_status_changes True
+ openstack-config --set /etc/neutron/neutron.conf DEFAULT notify_nova_on_port_data_changes True
+ openstack-config --set /etc/neutron/neutron.conf database connection mysql+pymysql://neutron:Super123@controller/neutron
+ openstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_host controller
+ openstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_userid openstack
+ openstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_password Super123
+ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_uri http://controller:5000
+ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_url http://controller:35357
+ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken memcached_servers controller:11211
+ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_type password
+ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_domain_name default
+ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken user_domain_name default
+ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_name service
+ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken username neutron
+ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken password Super123
+ openstack-config --set /etc/neutron/neutron.conf nova auth_url http://controller:35357
+ openstack-config --set /etc/neutron/neutron.conf nova auth_type password
+ openstack-config --set /etc/neutron/neutron.conf nova project_domain_name default
+ openstack-config --set /etc/neutron/neutron.conf nova user_domain_name default
+ openstack-config --set /etc/neutron/neutron.conf nova region_name RegionOne
+ openstack-config --set /etc/neutron/neutron.conf nova project_name service
+ openstack-config --set /etc/neutron/neutron.conf nova username nova
+ openstack-config --set /etc/neutron/neutron.conf nova password Super123
+ openstack-config --set /etc/neutron/neutron.conf oslo_concurrency lock_path /var/lib/neutron/tmp
+ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 type_drivers flat,vlan
+ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 tenant_network_types
+ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 mechanism_drivers linuxbridge
+ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 extension_drivers port_security
+ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2_type_flat flat_networks provider
+ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini securitygroup enable_ipset True
+ openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini linux_bridge physical_interface_mappings provider:enp0s8
+ openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini vxlan enable_vxlan False
+ openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup enable_security_group True
+ openstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup firewall_driver neutron.agent.linux.iptables_firewall.IptablesFirewallDriver
+ openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT interface_driver neutron.agent.linux.interface.BridgeInterfaceDriver
+ openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT dhcp_driver neutron.agent.linux.dhcp.Dnsmasq
+ openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT enable_isolated_metadata True
+ openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT verbose True
+ openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT nova_metadata_ip controller
+ openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT metadata_proxy_shared_secret Super123
+ openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT verbose True
+ openstack-config --set /etc/nova/nova.conf neutron url http://controller:9696
+ openstack-config --set /etc/nova/nova.conf neutron auth_url http://controller:35357
+ openstack-config --set /etc/nova/nova.conf neutron auth_type password
+ openstack-config --set /etc/nova/nova.conf neutron project_domain_name default
+ openstack-config --set /etc/nova/nova.conf neutron user_domain_name default
+ openstack-config --set /etc/nova/nova.conf neutron region_name RegionOne
+ openstack-config --set /etc/nova/nova.conf neutron project_name service
+ openstack-config --set /etc/nova/nova.conf neutron username neutron
+ openstack-config --set /etc/nova/nova.conf neutron password Super123
+ openstack-config --set /etc/nova/nova.conf neutron service_metadata_proxy True
+ openstack-config --set /etc/nova/nova.conf neutron metadata_proxy_shared_secret Super123
+ ln -s /etc/neutron/plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini
+ su -s /bin/sh -c 'neutron-db-manage --config-file /etc/neutron/neutron.conf   --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head' neutron
No handlers could be found for logger "oslo_config.cfg"
INFO  [alembic.runtime.migration] Context impl MySQLImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.runtime.migration] Context impl MySQLImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -> kilo, kilo_initial
INFO  [alembic.runtime.migration] Running upgrade kilo -> 354db87e3225, nsxv_vdr_metadata.py
INFO  [alembic.runtime.migration] Running upgrade 354db87e3225 -> 599c6a226151, neutrodb_ipam
INFO  [alembic.runtime.migration] Running upgrade 599c6a226151 -> 52c5312f6baf, Initial operations in support of address scopes
INFO  [alembic.runtime.migration] Running upgrade 52c5312f6baf -> 313373c0ffee, Flavor framework
INFO  [alembic.runtime.migration] Running upgrade 313373c0ffee -> 8675309a5c4f, network_rbac
INFO  [alembic.runtime.migration] Running upgrade 8675309a5c4f -> 45f955889773, quota_usage
INFO  [alembic.runtime.migration] Running upgrade 45f955889773 -> 26c371498592, subnetpool hash
INFO  [alembic.runtime.migration] Running upgrade 26c371498592 -> 1c844d1677f7, add order to dnsnameservers
INFO  [alembic.runtime.migration] Running upgrade 1c844d1677f7 -> 1b4c6e320f79, address scope support in subnetpool
INFO  [alembic.runtime.migration] Running upgrade 1b4c6e320f79 -> 48153cb5f051, qos db changes
INFO  [alembic.runtime.migration] Running upgrade 48153cb5f051 -> 9859ac9c136, quota_reservations
INFO  [alembic.runtime.migration] Running upgrade 9859ac9c136 -> 34af2b5c5a59, Add dns_name to Port
INFO  [alembic.runtime.migration] Running upgrade 34af2b5c5a59 -> 59cb5b6cf4d, Add availability zone
INFO  [alembic.runtime.migration] Running upgrade 59cb5b6cf4d -> 13cfb89f881a, add is_default to subnetpool
INFO  [alembic.runtime.migration] Running upgrade 13cfb89f881a -> 32e5974ada25, Add standard attribute table
INFO  [alembic.runtime.migration] Running upgrade 32e5974ada25 -> ec7fcfbf72ee, Add network availability zone
INFO  [alembic.runtime.migration] Running upgrade ec7fcfbf72ee -> dce3ec7a25c9, Add router availability zone
INFO  [alembic.runtime.migration] Running upgrade dce3ec7a25c9 -> c3a73f615e4, Add ip_version to AddressScope
INFO  [alembic.runtime.migration] Running upgrade c3a73f615e4 -> 659bf3d90664, Add tables and attributes to support external DNS integration
INFO  [alembic.runtime.migration] Running upgrade 659bf3d90664 -> 1df244e556f5, add_unique_ha_router_agent_port_bindings
INFO  [alembic.runtime.migration] Running upgrade 1df244e556f5 -> 19f26505c74f, Auto Allocated Topology - aka Get-Me-A-Network
INFO  [alembic.runtime.migration] Running upgrade 19f26505c74f -> 15be73214821, add dynamic routing model data
INFO  [alembic.runtime.migration] Running upgrade 15be73214821 -> b4caf27aae4, add_bgp_dragent_model_data
INFO  [alembic.runtime.migration] Running upgrade b4caf27aae4 -> 15e43b934f81, rbac_qos_policy
INFO  [alembic.runtime.migration] Running upgrade kilo -> 30018084ec99, Initial no-op Liberty contract rule.
INFO  [alembic.runtime.migration] Running upgrade 30018084ec99, 8675309a5c4f -> 4ffceebfada, network_rbac
INFO  [alembic.runtime.migration] Running upgrade 4ffceebfada -> 5498d17be016, Drop legacy OVS and LB plugin tables
INFO  [alembic.runtime.migration] Running upgrade 5498d17be016 -> 2a16083502f3, Metaplugin removal
INFO  [alembic.runtime.migration] Running upgrade 2a16083502f3 -> 2e5352a0ad4d, Add missing foreign keys
INFO  [alembic.runtime.migration] Running upgrade 2e5352a0ad4d -> 11926bcfe72d, add geneve ml2 type driver
INFO  [alembic.runtime.migration] Running upgrade 11926bcfe72d -> 4af11ca47297, Drop cisco monolithic tables
INFO  [alembic.runtime.migration] Running upgrade 4af11ca47297 -> 1b294093239c, Drop embrane plugin table
INFO  [alembic.runtime.migration] Running upgrade 1b294093239c, 32e5974ada25 -> 8a6d8bdae39, standardattributes migration
INFO  [alembic.runtime.migration] Running upgrade 8a6d8bdae39 -> 2b4c2465d44b, DVR sheduling refactoring
INFO  [alembic.runtime.migration] Running upgrade 2b4c2465d44b -> e3278ee65050, Drop NEC plugin tables
INFO  [alembic.runtime.migration] Running upgrade e3278ee65050, 15e43b934f81 -> c6c112992c9, rbac_qos_policy
INFO  [alembic.runtime.migration] Running upgrade c6c112992c9 -> 5ffceebfada, network_rbac_external
INFO  [alembic.runtime.migration] Running upgrade 15e43b934f81 -> 31ed664953e6, Add resource_versions row to agent table
INFO  [alembic.runtime.migration] Running upgrade 31ed664953e6 -> 2f9e956e7532, tag support
Running upgrade for neutron ...
OK
+ systemctl restart openstack-nova-api.service
+ systemctl enable neutron-server.service neutron-linuxbridge-agent.service neutron-dhcp-agent.service neutron-metadata-agent.service
Created symlink from /etc/systemd/system/multi-user.target.wants/neutron-server.service to /usr/lib/systemd/system/neutron-server.service.
Created symlink from /etc/systemd/system/multi-user.target.wants/neutron-linuxbridge-agent.service to /usr/lib/systemd/system/neutron-linuxbridge-agent.service.
Created symlink from /etc/systemd/system/multi-user.target.wants/neutron-dhcp-agent.service to /usr/lib/systemd/system/neutron-dhcp-agent.service.
Created symlink from /etc/systemd/system/multi-user.target.wants/neutron-metadata-agent.service to /usr/lib/systemd/system/neutron-metadata-agent.service.
+ systemctl start neutron-server.service neutron-linuxbridge-agent.service neutron-dhcp-agent.service neutron-metadata-agent.service
+ '[' '!' -f /root/.ssh/id_rsa ']'
+ echo 'already have rsa keys'
already have rsa keys
+ node_ip=10.0.0.31
+ ./ssh_key_auth.sh 10.0.0.31
spawn ssh-copy-id 10.0.0.31
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed

/usr/bin/ssh-copy-id: WARNING: All keys were skipped because they already exist on the remote system.

send: spawn id exp6 not open
    while executing
"send "yes\n""
    (file "./ssh_key_auth.sh" line 5)
+ scp ssh_key_auth.sh compute_init.sh 'root@10.0.0.31:~'
+ '[' '!' -f /root/compute1_neutron_finished ']'
+ echo 'installing neutron service'
installing neutron service
+ sleep 10
+ ssh root@10.0.0.31 '~/compute_init.sh'
+ '[' '!' -f /root/compute1_neutron_finished ']'
+ echo 'installing neutron service'
installing neutron service
+ sleep 10
+ '[' '!' -f /root/compute1_neutron_finished ']'
+ . admin-openrc
++ export OS_PROJECT_DOMAIN_NAME=default
++ OS_PROJECT_DOMAIN_NAME=default
++ export OS_USER_DOMAIN_NAME=default
++ OS_USER_DOMAIN_NAME=default
++ export OS_PROJECT_NAME=admin
++ OS_PROJECT_NAME=admin
++ export OS_USERNAME=admin
++ OS_USERNAME=admin
++ export OS_PASSWORD=Super123
++ OS_PASSWORD=Super123
++ export OS_AUTH_URL=http://controller:35357/v3
++ OS_AUTH_URL=http://controller:35357/v3
++ export OS_IDENTITY_API_VERSION=3
++ OS_IDENTITY_API_VERSION=3
++ export OS_IMAGE_API_VERSION=2
++ OS_IMAGE_API_VERSION=2
+ neutron ext-list
+---------------------------+----------------------------------+
| alias                     | name                             |
+---------------------------+----------------------------------+
| default-subnetpools       | Default Subnetpools              |
| security-group            | security-group                   |
| availability_zone         | Availability Zone                |
| network_availability_zone | Network Availability Zone        |
| net-mtu                   | Network MTU                      |
| auto-allocated-topology   | Auto Allocated Topology Services |
| port-security             | Port Security                    |
| binding                   | Port Binding                     |
| provider                  | Provider Network                 |
| agent                     | agent                            |
| quotas                    | Quota management support         |
| subnet_allocation         | Subnet Allocation                |
| dhcp_agent_scheduler      | DHCP Agent Scheduler             |
| tag                       | Tag support                      |
| rbac-policies             | RBAC Policies                    |
| external-net              | Neutron external network         |
| multi-provider            | Multi Provider Network           |
| allowed-address-pairs     | Allowed Address Pairs            |
| extra_dhcp_opt            | Neutron Extra DHCP opts          |
| address-scope             | Address scope                    |
+---------------------------+----------------------------------+
+ neutron agent-list
+--------------------------------------+--------------------+----------+-------------------+-------+----------------+---------------------------+
| id                                   | agent_type         | host     | availability_zone | alive | admin_state_up | binary                    |
+--------------------------------------+--------------------+----------+-------------------+-------+----------------+---------------------------+
| 7f3bb419-0a87-46a1-9f6d-e8fc1b4629cc | Linux bridge agent | compute1 |                   | :-)   | True           | neutron-linuxbridge-agent |
+--------------------------------------+--------------------+----------+-------------------+-------+----------------+---------------------------+
+ exit 0
